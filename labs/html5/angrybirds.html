<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Angry Birds in HTML 5</title>
<style type="text/css">
.canvas {
	position: absolute;
	top: -285px;	/* Beyond the screen. */
	z-index: 100;
}
.canvas:hover {
	cursor: pointer;
}
@-webkit-keyframes pohon {
	from {
		bottom: 0;
	}
	to {
		top: -4000;
	}
}
#pohon {
        background: white url(images/pohon.png) repeat-y 5% 5%;
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        z-index: 100;

        -webkit-animation-name: pohon;
        -webkit-animation-duration: 15s;
        -webkit-animation-timing-function: linear;
        -webkit-animation-iteration-count: infinite;
}
</style>
<script type="text/javascript" src="/scripts/jquery.latest.js"></script>
<script type="text/javascript">
$(function() {
	
	var bia	= -1;	// Bird in action.
	var imgURLs		= ["./images/red.png", "./images/purple.png", "./images/yellow.png"];
	var canvases	= new Array();
	var contexts 	= new Array();
	var images		= new Array();
	for (var i = 0; i < 3; i++) {

		var _i = i + 1;
		// Get context for the canvas.
		canvases[i] = document.getElementById("canvas_" + _i);
		contexts[i] = canvases[i].getContext("2d");
		images[i] 	= new Image();
		images[i].src = imgURLs[i];		
		contexts[i].drawImage(images[i], 0, 0);
		
		/*
		images[i].onload = function() {
			// TODO: context[i] is undefined.
			//contexts[i].drawImage(this, 0, 0);
			//document.getElementById("canvas_" + _i).getContext("2d").drawImage(this, 0, 0);
		}*/
		
	}
	
	// DEBUG
	for (var v = 0; v < 3; v++) {
		console.log(v + ": " + images[v].src);
	}
	
	/* This function rotates the canvas / image based on its center point. */
	function rotate() {
		contexts[bia].translate(canvases[bia].width / 2, canvases[bia].height / 2);
		contexts[bia].rotate(Math.PI/180 * 30);
		contexts[bia].translate(-canvases[bia].width / 2, -canvases[bia].height / 2);
		contexts[bia].drawImage(images[bia], 0, 0);
	}
	
	// Assume the target coordinate is (200, 200) for the first canvas.
	// TODO: Need to randomize the original x-coordinate and target y-coordinate.
	var xCoor = Math.floor(Math.random() * 500 + 1);
	var yCoor = Math.floor(Math.random() * 500 + 1);	
	var firstBird = Math.floor(Math.random() * images.length + 1);	// Generate a random number between 1 and images.length.
	console.log("First bird is (index of " + (firstBird - 1) + ") " + imgURLs[firstBird - 1]);
	$("#canvas_" + firstBird).css({ left: xCoor + "px" }).animate({ top: yCoor + "px" }, 500);
	
	$(".canvas").click(function() {
		// Ignore subsequent clicks to the same canvas that is currently animating.
		if ($(this).filter(":animated").length > 0) { return; }
		
		var id = $(this).attr('id').split('_')[1];
		bia = id - 1;
			
		console.log("Bird in action is (index of " + bia + ") " + images[bia].src);
		contexts[bia].save();
		var intervalId = setInterval(rotate, 5);
		var leftCoor = Math.floor(Math.random() * 500 + 1);
		$(this).animate({
			top: "-285px",
			left: leftCoor + "px"
		}, 500, function() { 
			clearInterval(intervalId);
									
			// Need to redraw the canvas to make sure the bird is facing downward (as in the image file).
			console.log("Animation done. Redrawing canvas for " + imgURLs[bia] + "...");
			
			contexts[bia].restore();
			contexts[bia].drawImage(images[bia], 0, 0, 285, 285);
			
			//console.log(contexts[bia]);
			
			/*
			var newContext = canvases[bia].getContext("2d");
			var newImage = new Image();
			newImage.src = imgURLs[bia];
			newImage.onload = function() {
				newContext.drawImage(newImage, 0, 0, 285, 285);
				console.log("Canvas redrawn done.");
			}
			*/
									
			var nextBird = Math.floor(Math.random() * images.length + 1);
			console.log("Next bird: " + imgURLs[nextBird - 1]);
			var xCoor = Math.floor(Math.random() * 500 + 1);
			var yCoor = Math.floor(Math.random() * 500 + 1);
			$("#canvas_" + nextBird).css({ left: xCoor + "px" }).animate({ "top": yCoor + "px" }, 500);
		});
	});
});
</script>
</head>
<body>
<div id="pohon"></div>
<canvas id="canvas_1" class="canvas" width="285" height="285">
	Sorry, your browser doesn't support Canvas.
</canvas>
<canvas id="canvas_2" class="canvas" width="285" height="285">
	Sorry, your browser doesn't support Canvas.
</canvas>
<canvas id="canvas_3" class="canvas" width="285" height="285">
	Sorry, your browser doesn't support Canvas.
</canvas>
</body>
</html>
